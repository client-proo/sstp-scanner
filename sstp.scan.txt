#!/usr/bin/env bash
# Hamid Scanner Menu: SSTP + DoH + Proxy Scanner

# Colors
RED="\033[31m"; GREEN="\033[32m"; YELLOW="\033[33m"; BLUE="\033[34m"
PURPLE="\033[35m"; CYAN="\033[36m"; MAGENTA="\033[35m"; RESET="\033[0m"
TAG="${PURPLE}┌────────────────────┐\n│ t.me/vpn_proxy66    │\n└────────────────────┘${RESET}"

# ----------------------------------------------------------
# Option 1 — SSTP Scanner
# ----------------------------------------------------------
scan_sstp() {
    PAGE_URL="https://ipspeed.info/free-sstp.php"

    echo "[*] Fetching SSTP servers..."
    HTML="$(curl -fsSL "$PAGE_URL")" || { echo "[!] Fetch failed"; return; }

    mapfile -t RAW_HOSTS < <(echo "$HTML" | grep -Eo '[a-zA-Z0-9.-]+\.[a-z]{2,6}:[0-9]{2,5}')

    if [[ ${#RAW_HOSTS[@]} -eq 0 ]]; then
      echo "[!] No hosts found"
      return
    fi

    echo "[*] Testing servers..."
    for item in "${RAW_HOSTS[@]}"; do
      host="${item%%:*}"
      port="${item##*:}"
      [[ "$host" == "$port" ]] && port=443

      if timeout 5 bash -c "echo > /dev/tcp/${host}/${port}" 2>/dev/null; then
        echo -e "${GREEN}[OPEN] ${host}:${port}${RESET}\n$TAG"
      else
        echo -e "${RED}[CLOSED] ${host}:${port}${RESET}\n$TAG"
      fi
    done
}

# ----------------------------------------------------------
# Option 2 — DoH Scanner (Fast + Progress % + Single Best)
# ----------------------------------------------------------
scan_doh_dns() {
    LIST_URL="https://raw.githubusercontent.com/10ium/Public-DNS-Collector/main/lists/doh.txt"
    TEST_DOMAIN="example.com"
    TIMEOUT=1
    PARALLEL=35

    echo -e "${MAGENTA}Downloading DoH list...${RESET}"
    LIST=$(curl -fsS "$LIST_URL") || { echo "Error downloading list"; return; }

    LIST=$(echo "$LIST" | grep -v '^$')
    TOTAL=$(echo "$LIST" | wc -l)
    echo "Total: $TOTAL servers"

    TMP=$(mktemp)
    current=0

    test_one() {
        base="$1"
        if [[ "$base" == *"dns-query"* ]]; then
            URL="$base?name=$TEST_DOMAIN&type=A"
        else
            URL="${base%/}/dns-query?name=$TEST_DOMAIN&type=A"
        fi

        RESULT=$(curl -s -H "accept: application/dns-json" --max-time $TIMEOUT -w "\n%{time_total}" "$URL")
        EXIT=$?
        [[ $EXIT -ne 0 ]] && return

        TIME=$(echo "$RESULT" | tail -n1)
        BODY=$(echo "$RESULT" | sed '$d')
        STATUS=$(echo "$BODY" | jq -r '.Status // 1' 2>/dev/null)

        [[ "$STATUS" == "0" ]] && echo "$TIME $URL" >> "$TMP"
    }

    for base in $LIST; do
        ((current++))
        PERCENT=$(( current * 100 / TOTAL ))
        echo -ne "Progress: $PERCENT%   \r"

        test_one "$base" &

        while (( $(jobs -r | wc -l) >= PARALLEL )); do
            sleep 0.05
        done
    done

    wait
    echo -e "\nDone.\n"

    BEST=$(sort -n "$TMP" | head -n1)
    rm -f "$TMP"

    if [[ -n "$BEST" ]]; then
        BEST_TIME=$(echo "$BEST" | awk '{print $1}')
        BEST_URL=$(echo "$BEST" | awk '{print $2}')

        echo -e "${GREEN}Fastest DoH:${RESET}"
        echo -e "${GREEN}$BEST_URL${RESET}"
        echo -e "${GREEN}Latency: $BEST_TIME sec${RESET}"
        echo
        echo "curl -H 'accept: application/dns-json' \"$BEST_URL\""
    else
        echo "No working DoH found."
    fi
}

# ----------------------------------------------------------
# Option 3 — Proxy Scanner from ipspeed.info
# ----------------------------------------------------------
scan_proxy() {
    PAGE_URL="https://ipspeed.info/free-proxy.php"

    echo -e "${CYAN}[*] Fetching proxy servers from ipspeed.info...${RESET}"
    HTML="$(curl -fsSL -H "User-Agent: Mozilla/5.0" "$PAGE_URL")" || { echo "[!] Fetch failed"; return; }

    # Extract proxy data from the table - improved pattern
    echo -e "${CYAN}[*] Parsing proxy data...${RESET}"
    
    # Extract table rows containing proxy data
    mapfile -t PROXY_ROWS < <(echo "$HTML" | grep -Eo '<tr>.*?</tr>' | grep -E '([0-9]{1,3}\.){3}[0-9]{1,3}')
    
    if [[ ${#PROXY_ROWS[@]} -eq 0 ]]; then
        # Alternative method: look for IP:Port patterns
        mapfile -t RAW_PROXIES < <(echo "$HTML" | grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}:[0-9]{2,5}')
    else
        # Parse table rows
        for row in "${PROXY_ROWS[@]}"; do
            # Extract IP address
            IP=$(echo "$row" | grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}')
            # Extract port (look for numbers in specific table cells)
            PORT=$(echo "$row" | grep -Eo '<td>[0-9]{2,5}</td>' | grep -Eo '[0-9]{2,5}' | head -1)
            
            if [[ -n "$IP" && -n "$PORT" ]]; then
                RAW_PROXIES+=("$IP:$PORT")
            fi
        done
    fi
    
    # If still no proxies found, try another method
    if [[ ${#RAW_PROXIES[@]} -eq 0 ]]; then
        echo -e "${YELLOW}[!] Trying alternative parsing method...${RESET}"
        # Look for any IP:Port combinations in the page
        mapfile -t RAW_PROXIES < <(echo "$HTML" | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+')
    fi

    if [[ ${#RAW_PROXIES[@]} -eq 0 ]]; then
        echo -e "${RED}[!] No proxy servers found on the page${RESET}"
        echo -e "${YELLOW}[*] Note: Website structure may have changed${RESET}"
        return
    fi

    echo -e "${GREEN}[+] Found ${#RAW_PROXIES[@]} proxy servers${RESET}"
    echo -e "${CYAN}[*] Testing proxies (this may take a while)...${RESET}"
    echo -e "${YELLOW}────────────────────────────────────────────${RESET}"

    WORKING_COUNT=0
    TEST_TIMEOUT=3
    TEST_URL="http://httpbin.org/ip"

    for proxy in "${RAW_PROXIES[@]}"; do
        IP="${proxy%%:*}"
        PORT="${proxy##*:}"
        
        echo -ne "Testing: $IP:$PORT\r"
        
        # Test 1: Check if port is open
        if timeout $TEST_TIMEOUT bash -c "echo > /dev/tcp/${IP}/${PORT}" 2>/dev/null; then
            # Test 2: Test proxy with curl
            if timeout $TEST_TIMEOUT curl -fsSL -x "http://${IP}:${PORT}" "$TEST_URL" &>/dev/null; then
                echo -e "${GREEN}[✓ WORKING] ${IP}:${PORT}${RESET}"
                echo "  └─ Use: curl -x http://${IP}:${PORT} http://example.com"
                echo -e "$TAG"
                ((WORKING_COUNT++))
            elif timeout $TEST_TIMEOUT curl -fsSL -x "socks5://${IP}:${PORT}" "$TEST_URL" &>/dev/null; then
                echo -e "${GREEN}[✓ SOCKS5] ${IP}:${PORT}${RESET}"
                echo "  └─ Use: curl --socks5 ${IP}:${PORT} http://example.com"
                echo -e "$TAG"
                ((WORKING_COUNT++))
            else
                echo -e "${YELLOW}[? OPEN PORT] ${IP}:${PORT} (but proxy test failed)${RESET}"
            fi
        else
            echo -e "${RED}[✗ CLOSED] ${IP}:${PORT}${RESET}"
        fi
    done

    echo -e "${YELLOW}────────────────────────────────────────────${RESET}"
    echo -e "${GREEN}[+] Summary: ${WORKING_COUNT}/${#RAW_PROXIES[@]} proxies working${RESET}"
    
    if [[ $WORKING_COUNT -gt 0 ]]; then
        echo -e "${CYAN}[*] Quick test command:${RESET}"
        echo -e "  curl -x http://PROXY_IP:PROXY_PORT http://httpbin.org/ip"
    fi
}

# ----------------------------------------------------------
# MENU
# ----------------------------------------------------------
while true; do
    clear
    echo -e "${MAGENTA}======================================${RESET}"
    echo -e "${MAGENTA}        t.me/vpn_proxy66 Menu         ${RESET}"
    echo -e "${MAGENTA}======================================${RESET}"
    echo
    echo -e "${CYAN}1) Scan SSTP Servers${RESET}"
    echo -e "${CYAN}2) Scan DoH DNS Servers${RESET}"
    echo -e "${CYAN}3) Scan Proxy Servers${RESET}"
    echo -e "${CYAN}0) Exit${RESET}"
    echo
    read -p "Choose option: " opt

    case $opt in
        1) scan_sstp; read -p "Press Enter to continue...";;
        2) scan_doh_dns; read -p "Press Enter to continue...";;
        3) scan_proxy; read -p "Press Enter to continue...";;
        0) echo -e "${GREEN}Goodbye!${RESET}"; exit 0;;
        *) echo -e "${RED}Invalid choice${RESET}"; sleep 1 ;;
    esac
done